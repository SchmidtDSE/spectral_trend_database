<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>spectral_trend_database.query &#8212; Spectral Trend Database 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for spectral_trend_database.query</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; utility methods</span>

<span class="sd">License:</span>
<span class="sd">    BSD, see LICENSE.md</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">TypeAlias</span><span class="p">,</span> <span class="n">Literal</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">bigquery</span> <span class="k">as</span> <span class="n">bq</span>
<span class="kn">from</span> <span class="nn">spectral_trend_database.config</span> <span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">c</span>
<span class="kn">from</span> <span class="nn">spectral_trend_database</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">spectral_trend_database</span> <span class="kn">import</span> <span class="n">types</span>


<span class="c1">#</span>
<span class="c1"># CONSTANTS</span>
<span class="c1">#</span>
<span class="n">OPERATOR_SUFFIX</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;op&#39;</span>
<span class="n">DEFAULT_OPERATOR</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;=&#39;</span>
<span class="n">TABLE_KEYS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;join_table&#39;</span><span class="p">]</span>


<span class="c1">#</span>
<span class="c1"># CLASSES</span>
<span class="c1">#</span>
<div class="viewcode-block" id="QueryConstructor">
<a class="viewcode-back" href="../../docs/spectral_trend_database.html#spectral_trend_database.query.QueryConstructor">[docs]</a>
<span class="k">class</span> <span class="nc">QueryConstructor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; class for constructing SQL queries</span>

<span class="sd">    Usage:</span>

<span class="sd">        Constructs SQL queries</span>

<span class="sd">        using python:</span>

<span class="sd">        ```python</span>
<span class="sd">        sqlc = QueryConstructor(&#39;table1&#39;, using=&#39;sample_id&#39;)</span>
<span class="sd">        sqlc.select(&#39;sample_id&#39;, &#39;c1&#39;, &#39;c2&#39;, c3=&#39;c_three&#39;)</span>
<span class="sd">        sqlc.join(&#39;table2&#39;, how=&#39;right&#39;, on=&#39;c2&#39;)</span>
<span class="sd">        sqlc.join(&#39;table3&#39;, on=(&#39;c2&#39;, &#39;c3p2&#39;))</span>
<span class="sd">        sqlc.join(&#39;table4&#39;)</span>
<span class="sd">        sqlc.where(c2=123456)</span>
<span class="sd">        sqlc.where(&#39;table3&#39;, c_three=1234, c_three_op=&#39;&lt;=&#39;)</span>
<span class="sd">        sqlc.limit(100)</span>
<span class="sd">        print(sqlc.sql())</span>
<span class="sd">        ```</span>

<span class="sd">        or using a config file:</span>

<span class="sd">        ```yaml</span>
<span class="sd">        # example.yaml</span>
<span class="sd">        init:</span>
<span class="sd">            table: table1</span>
<span class="sd">            using: sample_id</span>
<span class="sd">            table_escape: null</span>
<span class="sd">        select:</span>
<span class="sd">            - c1, c2</span>
<span class="sd">            - c3: as c_three</span>
<span class="sd">        join:</span>
<span class="sd">            - table: table2</span>
<span class="sd">              how: right</span>
<span class="sd">              on: c2</span>
<span class="sd">            - table: table3</span>
<span class="sd">              on:</span>
<span class="sd">                - c2</span>
<span class="sd">                - c3p2</span>
<span class="sd">            - table: table 4</span>
<span class="sd">        where:</span>
<span class="sd">            - c2: 123456</span>
<span class="sd">            - table: table3</span>
<span class="sd">              c_three: 1234</span>
<span class="sd">              c_three_op: &#39;&lt;=&#39;</span>
<span class="sd">        limit: 100</span>
<span class="sd">        ```</span>

<span class="sd">        ```python</span>
<span class="sd">        sqlc = QueryConstructor.from_config(&#39;table1&#39;, using=&#39;sample_id&#39;)</span>
<span class="sd">        print(sqlc.sql())</span>
<span class="sd">        ```</span>

<span class="sd">        resulting in</span>

<span class="sd">        ```sql</span>
<span class="sd">        SELECT sample_id, c1, c2, c3 as c_three FROM table1</span>
<span class="sd">        RIGHT JOIN table2 ON table1.c2 = table2.c2</span>
<span class="sd">        LEFT JOIN table3 ON table1.c2 = table3.c3p2</span>
<span class="sd">        LEFT JOIN table4 USING (sample_id)</span>
<span class="sd">        WHERE table1.c2 = 123456 AND table3.c_three &lt;= 1234</span>
<span class="sd">        LIMIT 100</span>

<span class="sd">        &#39;SELECT c1, c2, c3 as as c_three FROM `table1`</span>
<span class="sd">        RIGHT JOIN `table2` USING (sample_id)</span>
<span class="sd">        LEFT JOIN `table3` USING (sample_id)</span>
<span class="sd">        LEFT JOIN `table 4` USING (sample_id)</span>
<span class="sd">        WHERE `table1`.c2 = 123456 AND `table3`.c_three &lt;= 1234</span>
<span class="sd">        LIMIT 100&#39;</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1"># CLASS METHODS</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="QueryConstructor.from_config">
<a class="viewcode-back" href="../../docs/spectral_trend_database.html#spectral_trend_database.query.QueryConstructor.from_config">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; generate QueryConstructor instance from config file</span>

<span class="sd">        Constructs SQL query sing a config dict where each of the keys are methods on</span>
<span class="sd">        QueryConstructor, where the values are dicts or list of dicts for the arguments</span>
<span class="sd">        of the QueryConstructor methods.</span>

<span class="sd">        Note the QueryConstructor.__init__ function simply uses the key &quot;init&quot;.</span>

<span class="sd">        EXAMPLE:</span>

<span class="sd">            ```yaml</span>
<span class="sd">            # example.yaml</span>
<span class="sd">            init:</span>
<span class="sd">                table: table1</span>
<span class="sd">                using: sample_id</span>
<span class="sd">                table_escape: null</span>
<span class="sd">            join:</span>
<span class="sd">                - table: table2</span>
<span class="sd">                - table: table3</span>
<span class="sd">                - table: table3</span>
<span class="sd">                  using:</span>
<span class="sd">                    - sample_id</span>
<span class="sd">                    - year</span>
<span class="sd">            where:</span>
<span class="sd">                - year: 2020</span>
<span class="sd">                - year_op: &#39;&lt;=&#39;</span>
<span class="sd">            ```</span>

<span class="sd">            ```python</span>
<span class="sd">            config = load_yaml(&#39;example.yaml&#39;)</span>
<span class="sd">            sqlc = QueryConstructor.from_config(config)</span>
<span class="sd">            print(sqlc.sql())</span>
<span class="sd">            ```</span>

<span class="sd">            ```sql</span>
<span class="sd">            SELECT * FROM table1</span>
<span class="sd">            LEFT JOIN table2 USING (sample_id)</span>
<span class="sd">            LEFT JOIN table3 USING (sample_id)</span>
<span class="sd">            LEFT JOIN table3 USING (sample_id, year)</span>
<span class="sd">            WHERE table1.year &lt;= 2020</span>
<span class="sd">            ```</span>

<span class="sd">        Notes:</span>

<span class="sd">            - JOIN note on &quot;on&quot;:</span>
<span class="sd">                PyYaml converts &quot;on&quot; to True (even for keys). i&#39;ve allowed</span>
<span class="sd">                for &quot;on&quot;-key in 3 ways:</span>
<span class="sd">                    1. make string explicit with quotes. ie `&#39;on&#39;: sample_id`</span>
<span class="sd">                    2. use &quot;on_columns&quot;: ie `on_columns: sample_id`</span>
<span class="sd">                    3. leave it as on. the config will show up `True: sample_id`, but</span>
<span class="sd">                       within a join this will be converted to &quot;on&quot;.</span>

<span class="sd">            - WHERE note on &quot;_op&quot;:</span>
<span class="sd">                As discussed below: in the `where` method if kwarg ends in &quot;_op&quot; it is</span>
<span class="sd">                used as the comparison operator (otherwise the operator) is &quot;=&quot;.</span>

<span class="sd">                for example:</span>
<span class="sd">                    `year=2010` =&gt;  &quot;... WHERE year=2010&quot;, but</span>
<span class="sd">                    `year=2010, year_op=&quot;&lt;&quot;` =&gt; &quot;... WHERE year&lt;2010&quot;</span>

<span class="sd">                this will be problamatic in a yaml file for some operators. escape these values</span>
<span class="sd">                with quotes: ie `year_op: &#39;&lt;=&#39;`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">init</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
        <span class="n">lim</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;limit&#39;</span><span class="p">)</span>
        <span class="n">qc</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">init</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_cfig</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_args_as_list</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_process_args_kwargs</span><span class="p">(</span><span class="n">_cfig</span><span class="p">)</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_cfig</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_args_as_list</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;join&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">_cfig</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">)</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">table</span><span class="p">,</span>
                <span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">_as_list</span><span class="p">(</span><span class="n">_cfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;using&#39;</span><span class="p">,</span> <span class="p">[])),</span>
                <span class="n">how</span><span class="o">=</span><span class="n">_cfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;how&#39;</span><span class="p">),</span>
                <span class="n">on</span><span class="o">=</span><span class="n">_cfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_cfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;on_columns&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_cfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">join_table</span><span class="o">=</span><span class="n">_cfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;join_table&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">_cfig</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_args_as_list</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;where&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">safe_table</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_cfig</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span> <span class="k">if</span> <span class="n">t</span><span class="p">]</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">*</span><span class="n">safe_table</span><span class="p">,</span> <span class="o">**</span><span class="n">_cfig</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_cfig</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_args_as_list</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_cfig</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lim</span><span class="p">:</span>
            <span class="n">qc</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qc</span></div>


    <span class="c1">#</span>
    <span class="c1"># PUBLIC</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">table_prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">table_escape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;`&#39;</span><span class="p">,</span>
            <span class="n">how</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">JOINS</span> <span class="o">=</span> <span class="s1">&#39;LEFT&#39;</span><span class="p">,</span>
            <span class="n">on</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">STRINGS</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">using</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">STRINGS</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            table (str): table-name</span>
<span class="sd">            table_prefix (Optional[str] = None):</span>
<span class="sd">                prefix to be added to table/joint_table names.</span>
<span class="sd">                if &lt;table_prefix&gt; and &#39;.&#39; not in &lt;table&gt;/&lt;joint_table&gt;</span>
<span class="sd">                then &lt;table&gt;/&lt;joint_table&gt; =&gt; &lt;table_prefix&gt;.&lt;table&gt;/&lt;joint_table&gt;</span>
<span class="sd">            table_escape (Optional[str] = &#39;`&#39;):</span>
<span class="sd">                if exists escape table names using this value.</span>
<span class="sd">                ie if table_escape = &#39;`&#39;: TABLE_NAME =&gt; `TABLE_NAME`</span>
<span class="sd">            how (types.JOINS=&#39;LEFT&#39;):</span>
<span class="sd">                default type of join [LEFT, RIGHT, INNER, OUTER]</span>
<span class="sd">                note: lower case allowed</span>
<span class="sd">            on (Optional[types.STRINGS]=None):</span>
<span class="sd">                string or list of strings to `JOIN ... ON`</span>
<span class="sd">            using (Optional[types.STRINGS]=None):</span>
<span class="sd">                string or list of strings to `JOIN ... USING`</span>
<span class="sd">                note: &lt;using&gt; takes precedence over &lt;on&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_how</span> <span class="o">=</span> <span class="n">how</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_list</span><span class="p">(</span><span class="n">on</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_using</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_list</span><span class="p">(</span><span class="n">using</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_prefix</span> <span class="o">=</span> <span class="n">table_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table_escape</span> <span class="o">=</span> <span class="n">table_escape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

<div class="viewcode-block" id="QueryConstructor.reset">
<a class="viewcode-back" href="../../docs/spectral_trend_database.html#spectral_trend_database.query.QueryConstructor.reset">[docs]</a>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; resets instance &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_join_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_where_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="QueryConstructor.select">
<a class="viewcode-back" href="../../docs/spectral_trend_database.html#spectral_trend_database.query.QueryConstructor.select">[docs]</a>
    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">columns_as</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; add select columns</span>

<span class="sd">        Note: if not called select will revert to `SELECT *`</span>

<span class="sd">        Args:</span>
<span class="sd">            *columns (str): names of columns to include</span>
<span class="sd">            **columns_as (str): key (name) value (as-name) pairs for renaming columns</span>

<span class="sd">        Usage:</span>
<span class="sd">            ```python</span>
<span class="sd">            sqlc.select(&#39;column_1&#39;, &#39;column_2&#39;, column_3=&#39;c3&#39;)</span>
<span class="sd">            ...</span>
<span class="sd">            sqlc.sql() # =&gt; &#39;SELECT column_1, column_2, column_3 as c3 FROM ...&#39;</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
            <span class="n">columns_as</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">columns_as</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_list</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> as </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">columns_as</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span></div>


<div class="viewcode-block" id="QueryConstructor.join">
<a class="viewcode-back" href="../../docs/spectral_trend_database.html#spectral_trend_database.query.QueryConstructor.join">[docs]</a>
    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="o">*</span><span class="n">using</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">how</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">on</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">join_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; add join</span>

<span class="sd">        When constructing JOINs we prioritze &lt;using&gt; over &lt;on&gt;. Namely:</span>
<span class="sd">            1. If &lt;using&gt; use &lt;using&gt;</span>
<span class="sd">            2. Else If &lt;on&gt; use &lt;on&gt;</span>
<span class="sd">            3. Else If &lt;self._default_using&gt; use &lt;self._default_using&gt;</span>
<span class="sd">            4. Else If &lt;self._default_on&gt; use &lt;self._default_on&gt;</span>

<span class="sd">        Args:</span>
<span class="sd">            table (str): table name to join</span>
<span class="sd">            *using (str):</span>
<span class="sd">                column names for `JOIN ... USING`</span>
<span class="sd">                uses default &lt;using&gt; set in initialization method if None</span>
<span class="sd">            how (Optional[str]=None):</span>
<span class="sd">                type of join [LEFT, RIGHT, INNER, OUTER]</span>
<span class="sd">                uses default &lt;how&gt; set in initialization method if None</span>
<span class="sd">            on (Optional[Union[Sequence, str]]=None):</span>
<span class="sd">                string or list of strings to `JOIN ... ON`</span>
<span class="sd">                uses default &lt;on&gt; set in initialization method if None</span>
<span class="sd">            join_table (Optional[str]=None):</span>
<span class="sd">                name of table to join with</span>
<span class="sd">                uses &lt;table&gt; passed in initialization method if None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="n">join_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">(</span><span class="n">join_table</span><span class="p">)</span>
        <span class="n">join_element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_element</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">join_table</span><span class="p">,</span> <span class="n">how</span><span class="p">,</span> <span class="n">using</span><span class="p">,</span> <span class="n">on</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_join_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">join_element</span><span class="p">)</span></div>


<div class="viewcode-block" id="QueryConstructor.where">
<a class="viewcode-back" href="../../docs/spectral_trend_database.html#spectral_trend_database.query.QueryConstructor.where">[docs]</a>
    <span class="k">def</span> <span class="nf">where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; add where statement</span>

<span class="sd">        Sets where statement through key value pairs.</span>

<span class="sd">        if kwarg ends in &quot;_op&quot; it is used as the comparison operator</span>
<span class="sd">        (otherwise the operator) is &quot;=&quot;.</span>

<span class="sd">        for example:</span>
<span class="sd">            `year=2010` =&gt;  &quot;... WHERE year=2010&quot;, but</span>
<span class="sd">            `year=2010, year_op=&quot;&lt;&quot;` =&gt; &quot;... WHERE year&lt;2010&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            table (str): table name used in where statement</span>
<span class="sd">            **kwargs (Union[str, int, float]):</span>
<span class="sd">                key value pairs for where statement</span>
<span class="sd">                operators set using &quot;_op&quot; as described above</span>

<span class="sd">        Usage:</span>
<span class="sd">            ```python</span>
<span class="sd">            sqlc.where(&#39;table2&#39;, year=2020, year_op=&#39;&lt;&#39;, sample_id=&#39;asd23ragwd&#39;)</span>
<span class="sd">            ...</span>
<span class="sd">            sqlc.sql() # =&gt; &#39;... WHERE table2.year &lt; 2020 AND table2.sample_id = &quot;asd23ragwd&quot;&#39;</span>
<span class="sd">            ```</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_name</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="n">keys_values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">OPERATOR_SUFFIX</span><span class="si">}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">keys_values</span><span class="p">:</span>
            <span class="n">op</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">OPERATOR_SUFFIX</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">DEFAULT_OPERATOR</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_where_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="n">table</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_query_value</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">),</span>
                <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="n">op</span><span class="p">})</span></div>


<div class="viewcode-block" id="QueryConstructor.append">
<a class="viewcode-back" href="../../docs/spectral_trend_database.html#spectral_trend_database.query.QueryConstructor.append">[docs]</a>
    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; append strings seperated by a space to end of sql statement</span>

<span class="sd">        This has been included to allow users to add explicit SQL statements which</span>
<span class="sd">        may not be possible with current API.</span>

<span class="sd">        Args:</span>
<span class="sd">            *values (str):</span>
<span class="sd">                append each element of &lt;values&gt; to end of sql statement</span>
<span class="sd">                but before LIMIT</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append_list</span> <span class="o">+=</span> <span class="n">values</span></div>


<div class="viewcode-block" id="QueryConstructor.limit">
<a class="viewcode-back" href="../../docs/spectral_trend_database.html#spectral_trend_database.query.QueryConstructor.limit">[docs]</a>
    <span class="k">def</span> <span class="nf">limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_rows</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; limit number of rows</span>

<span class="sd">        Args:</span>
<span class="sd">            max_rows (Optional[int]=None): if exists limit number of rows</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">max_rows</span></div>


<div class="viewcode-block" id="QueryConstructor.sql">
<a class="viewcode-back" href="../../docs/spectral_trend_database.html#spectral_trend_database.query.QueryConstructor.sql">[docs]</a>
    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; get sql statement</span>

<span class="sd">        This will construct (if not yet constructed or `force=True`) the sql statment and return</span>
<span class="sd">        the string.</span>

<span class="sd">        Args:</span>
<span class="sd">            force (bool=False): if true (re)construct sql statement even if it already exists</span>
<span class="sd">        Returns:</span>
<span class="sd">            (str) SQL statement</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">force</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_sql</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql</span></div>


    <span class="c1">#</span>
    <span class="c1"># INTERNAL (STATIC &amp; CLASS)</span>
    <span class="c1">#</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_process_args_kwargs</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_as_list</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_args_as_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_as_list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># INTERNAL (INSTANCE)</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">_table_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">table</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_prefix</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table</span><span class="p">):</span>
                <span class="n">table</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_prefix</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>
        <span class="k">if</span> <span class="n">table</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_escape</span><span class="p">:</span>
            <span class="n">rgx</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_escape</span><span class="si">}</span><span class="s1">.+</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_escape</span><span class="si">}</span><span class="s1">$&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">rgx</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
                <span class="n">table</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_escape</span><span class="si">}{</span><span class="n">table</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">_table_escape</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">table</span>

    <span class="k">def</span> <span class="nf">_construct_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; construct (and return) the sql-statement</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_select</span> <span class="o">=</span> <span class="s1">&#39;SELECT &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_select</span> <span class="o">=</span> <span class="s1">&#39;SELECT *&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; FROM </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">sql_statement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_join</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_join_list</span><span class="p">)</span>
            <span class="n">sql_statement</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where_list</span><span class="p">:</span>
            <span class="n">where_statements</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_where</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where_list</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_where</span> <span class="o">=</span> <span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where_statements</span><span class="p">)</span>
            <span class="n">sql_statement</span> <span class="o">+=</span> <span class="s1">&#39; WHERE &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_list</span><span class="p">:</span>
            <span class="n">sql_statement</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_append_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="p">:</span>
            <span class="n">sql_statement</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; LIMIT </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_limit</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">sql_statement</span>

    <span class="k">def</span> <span class="nf">_join_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">join_table</span><span class="p">,</span> <span class="n">how</span><span class="p">,</span> <span class="n">using</span><span class="p">,</span> <span class="n">on</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; construct JOIN-statement part &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">how</span><span class="p">:</span>
            <span class="n">how</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_how</span>
        <span class="n">_statement</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">how</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1"> JOIN </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">using</span> <span class="ow">or</span> <span class="n">on</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_using</span><span class="p">:</span>
                <span class="n">using</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_using</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_on</span>
        <span class="k">if</span> <span class="n">using</span><span class="p">:</span>
            <span class="n">_statement</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; USING (</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">using</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">elif</span> <span class="n">on</span><span class="p">:</span>
            <span class="n">on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_list</span><span class="p">(</span><span class="n">on</span><span class="p">)</span>
            <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_on</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">join_table</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">on</span><span class="p">]</span>
            <span class="n">_statement</span> <span class="o">+=</span> <span class="s1">&#39; ON &#39;</span> <span class="o">+</span> <span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">on</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;statement required&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_statement</span>

    <span class="k">def</span> <span class="nf">_process_where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">operator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; construct WHERE-statement part &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">operator</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">_process_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">join_table</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; construct ON-statement part &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
        <span class="n">nb_parts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nb_parts</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">nb_parts</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;query.QueryConstructor._process_on&#39;</span>
                <span class="s1">&#39;value must be tuple of len 2, or&#39;</span>
                <span class="s1">&#39;a string containg no more than one comma&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">join_table</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">v1</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">v2</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">_sql_query_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">op</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; safe query value</span>
<span class="sd">        if value not int or float or &quot;on&quot;-operator return in quotes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&quot;&#39;</span></div>



<span class="c1">#</span>
<span class="c1"># METHODS</span>
<span class="c1">#</span>
<div class="viewcode-block" id="process_named_query_config">
<a class="viewcode-back" href="../../docs/spectral_trend_database.html#spectral_trend_database.query.process_named_query_config">[docs]</a>
<span class="k">def</span> <span class="nf">process_named_query_config</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">query_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts named query from queries config, and adds defaults.</span>
<span class="sd">    as well as table_prefix.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (dict): queries-config as described above</span>
<span class="sd">        query_name (str):</span>
<span class="sd">            key for query in queries-config</span>
<span class="sd">            to extract: config[&#39;queries&#39;][&lt;query_name&gt;]</span>
<span class="sd">    Returns:</span>
<span class="sd">        (dict) query-config that can be passed to</span>
<span class="sd">        QueryConstructor.from_config(...)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;defaults&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">table_prefix</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;table_prefix&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">table_prefix</span><span class="p">:</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset&#39;</span><span class="p">)</span>
        <span class="n">table_prefix</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="n">project</span><span class="p">,</span> <span class="n">dataset</span><span class="p">]</span> <span class="k">if</span> <span class="n">v</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">query_name</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;queries&#39;</span><span class="p">][</span><span class="n">query_name</span><span class="p">]</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">,</span> <span class="p">{})}</span>
    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">][</span><span class="s1">&#39;table_prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;table_prefix&#39;</span><span class="p">,</span> <span class="n">table_prefix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config</span></div>



<div class="viewcode-block" id="queries">
<a class="viewcode-back" href="../../docs/spectral_trend_database.html#spectral_trend_database.query.queries">[docs]</a>
<span class="k">def</span> <span class="nf">queries</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">DEFAULT_QUERY_CONFIG</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; list of queries in config file</span>

<span class="sd">    Args:</span>
<span class="sd">        - config (Union[str,dict]=c.DEFAULT_QUERY_CONFIG):</span>
<span class="sd">            configuration dictionary containg sql-config with key &lt;name&gt;</span>
<span class="sd">            if (str):</span>
<span class="sd">                if re.search(r&#39;(yaml|yml)$&#39;, &lt;config&gt;) loads yaml file with at &lt;path config&gt;</span>
<span class="sd">                else loads yaml at &#39;&lt;project-root&gt;/config/named_queries/&lt;config&gt;.yaml&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(yaml|yml)$&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
            <span class="n">config</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">NAMED_QUERY_DIR</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s1">.yaml&#39;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;queries&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>



<div class="viewcode-block" id="named_sql">
<a class="viewcode-back" href="../../docs/spectral_trend_database.html#spectral_trend_database.query.named_sql">[docs]</a>
<span class="k">def</span> <span class="nf">named_sql</span><span class="p">(</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">select</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">DEFAULT_QUERY_CONFIG</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">uppercase_table</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">values</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; generate sql command from config file</span>

<span class="sd">    Uses config file and kwargs to generate SQL query statements. The named query statements</span>
<span class="sd">    are given as a dict whose keys are the names and the values are configs as discussed in</span>
<span class="sd">    doc-string for QueryConstructor.from_config above.  Additionally, default values for the</span>
<span class="sd">    initializer can be added to be used in all &quot;named queries&quot;.</span>


<span class="sd">    Additionally, pass a &lt;table&gt; to construct simple quieres (where and limit only)</span>
<span class="sd">    on a single table.</span>

<span class="sd">    Config Description:</span>

<span class="sd">        queries-config files have the following parts</span>

<span class="sd">        ```yaml</span>
<span class="sd">        project: |</span>
<span class="sd">            [optional] (str) gcp project-name used to generate default table_prefix</span>
<span class="sd">            if table_prefix absent. ie table_prefix = project.dataset</span>

<span class="sd">        dataset: |</span>
<span class="sd">            [optional] (str) gcp dataset-name used to generate default table_prefix</span>
<span class="sd">            if table_prefix absent. ie table_prefix = project.dataset</span>

<span class="sd">        defaults: |</span>
<span class="sd">            [optional] (dict) default init values for all named queries. may contain</span>
<span class="sd">            all arguments to QueryConstructor(...) except `table`.</span>
<span class="sd">            namely: `table_prefix`, `how`, `on`, and `using`.</span>

<span class="sd">            notes:</span>
<span class="sd">                - if table_prefix is absent/empty and `project` and/or `dataset` exist a</span>
<span class="sd">                  table_prefix = project.dataset will be added.</span>
<span class="sd">                - `init` dicts in `queries` dicts below will override the defaults</span>

<span class="sd">        queries: |</span>
<span class="sd">            (dict) key-value pairs of query-name, query-config. the key value pairs are</span>

<span class="sd">            key: (str) name of query</span>
<span class="sd">            value: |</span>
<span class="sd">                (dict | list[dict]) dicts of args/kwargs to QueryConstructor __init__</span>
<span class="sd">                method (key = `init`) as well as each of QueryConstructor main public methods.</span>
<span class="sd">                Namely: `select`, `join`, `where`, `append`, and `limit`.</span>

<span class="sd">                if value is dict the dict args will be passed to named method</span>
<span class="sd">                if value is list[dict] for each element of value the dict args</span>
<span class="sd">                will be passed to named method</span>


<span class="sd">            Example:</span>

<span class="sd">                ```yaml</span>

<span class="sd">                ...</span>

<span class="sd">                queries:</span>
<span class="sd">                  raw_landsat:</span>
<span class="sd">                    init:</span>
<span class="sd">                        table: SAMPLE_POINTS</span>
<span class="sd">                        using: sample_id</span>
<span class="sd">                    join:</span>
<span class="sd">                        table: LANDSAT_RAW_MASKED</span>
<span class="sd">                  raw_landsat_between_2020_and_2020:</span>
<span class="sd">                    init:</span>
<span class="sd">                        table: SAMPLE_POINTS</span>
<span class="sd">                    join:</span>
<span class="sd">                        table: LANDSAT_RAW_MASKED</span>
<span class="sd">                    where:</span>
<span class="sd">                        - year: 2010</span>
<span class="sd">                          year_op: &#39;&gt;=&#39;</span>
<span class="sd">                        - year: 2020</span>
<span class="sd">                          year_op: &lt;</span>
<span class="sd">                    limit: 23</span>
<span class="sd">                  scym_raw_landsat:</span>
<span class="sd">                    init:</span>
<span class="sd">                        table: SAMPLE_POINTS</span>
<span class="sd">                    join:</span>
<span class="sd">                        - table: SCYM_YIELD</span>
<span class="sd">                        - table: LANDSAT_RAW_MASKED</span>
<span class="sd">                          using: sample_id, year</span>
<span class="sd">                ```</span>

<span class="sd">    Notes:</span>

<span class="sd">        - The gcp project and dataset are set using the `project`/`dataset` values. These will</span>
<span class="sd">          be used to prepend table/join_table names if the table/join_table names do not contain &#39;.&#39;</span>

<span class="sd">        - The `defaults` dict can set default `how`, `on`, and `using` passed to the</span>
<span class="sd">          QueryConstructor initializer</span>

<span class="sd">        - `queries` is a dictionary with all the named queries. We start my adding creating a</span>
<span class="sd">          select statement &#39;SELECT {select} FROM {table}&#39;, where &quot;{}&quot; indicate the value</span>
<span class="sd">          subtracted from the named-query dict or the defaults dict. Then we sequentially loop</span>
<span class="sd">          over the join list using the {table} and {join} values.</span>

<span class="sd">    Examples:</span>

<span class="sd">        for:</span>

<span class="sd">        ```yaml</span>
<span class="sd">        project: dse-regenag</span>
<span class="sd">        dataset: BiomassTrends</span>
<span class="sd">        defaults:</span>
<span class="sd">            using: sample_id</span>
<span class="sd">        queries:</span>
<span class="sd">            raw_landsat:</span>
<span class="sd">                init:</span>
<span class="sd">                    table: SAMPLE_POINTS</span>
<span class="sd">                join:</span>
<span class="sd">                    table: LANDSAT_RAW_MASKED</span>
<span class="sd">                    using: sample_id, year</span>
<span class="sd">        ```</span>

<span class="sd">        `named_sql(&#39;raw_landsat&#39;)` will output</span>

<span class="sd">        ```sql</span>
<span class="sd">        SELECT * FROM `dse-regenag.BiomassTrends.SAMPLE_POINTS`</span>
<span class="sd">        LEFT JOIN `dse-regenag.BiomassTrends.LANDSAT_RAW_MASKED`</span>
<span class="sd">        USING (sample_id, year)</span>
<span class="sd">        ```</span>

<span class="sd">        We can also add a `where` key:</span>

<span class="sd">        ``` yaml</span>
<span class="sd">          scym_raw_for_2012:</span>
<span class="sd">            table: SAMPLE_POINTS</span>
<span class="sd">            join:</span>
<span class="sd">              - table: SCYM_YIELD</span>
<span class="sd">              - table: LANDSAT_RAW_MASKED</span>
<span class="sd">                using: sample_id, year</span>
<span class="sd">            where:</span>
<span class="sd">                year: 2012</span>
<span class="sd">        ```</span>

<span class="sd">        now `named_sql(&#39;scym_raw_for_2012&#39;)` will output</span>

<span class="sd">        ```sql</span>
<span class="sd">        SELECT * FROM `dse-regenag.BiomassTrends.SAMPLE_POINTS`</span>
<span class="sd">        LEFT JOIN `dse-regenag.BiomassTrends.LANDSAT_RAW_MASKED`</span>
<span class="sd">        USING (sample_id, year)</span>
<span class="sd">        WHERE `dse-regenag.BiomassTrends.SAMPLE_POINTS`.year = 2012</span>
<span class="sd">        ```</span>

<span class="sd">        That said, hard coding the where might not be what is desired you can</span>
<span class="sd">        also do this `named_sql(&#39;raw_landsat&#39;, year=2012)` to achieve the same</span>
<span class="sd">        result.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (Optional[str]=None): name of preconfigured config file</span>
<span class="sd">        table (Optional[str]=None):</span>
<span class="sd">            (required if name is None) table-name: queries a</span>
<span class="sd">            single table with optional `WHERE` clause added through</span>
<span class="sd">            `values` kwargs.</span>
<span class="sd">        select (Optional[str] = None):</span>
<span class="sd">            a simple select string ie &#39;col1, col2, col3 as c3&#39;</span>
<span class="sd">        config (Union[str,dict]=c.DEFAULT_QUERY_CONFIG):</span>
<span class="sd">            configuration dictionary containg sql-config with key &lt;name&gt;</span>
<span class="sd">            if (str):</span>
<span class="sd">                if re.search(r&#39;(yaml|yml)$&#39;, &lt;config&gt;) loads yaml file with at &lt;path config&gt;</span>
<span class="sd">                else loads yaml at &#39;&lt;project-root&gt;/config/named_queries/&lt;config&gt;.yaml&#39;</span>
<span class="sd">        limit (int=None):</span>
<span class="sd">            if exits add &quot;LIMIT &lt;limit&gt;&quot; to end of SQL call</span>
<span class="sd">        uppercase_table (bool = True):</span>
<span class="sd">            if true apply `.upper()` to &lt;table&gt;. Note only used if &lt;table&gt;</span>
<span class="sd">            is non-null.</span>
<span class="sd">        **values:</span>
<span class="sd">            values for where clause (see usage above).</span>

<span class="sd">            note: if kwarg ends in &quot;_op&quot; it is used as the comparison operator</span>
<span class="sd">            (otherwise the operator) is &quot;=&quot;.</span>

<span class="sd">            for example:</span>
<span class="sd">                `year=2010` =&gt;  &quot;... WHERE year=2010&quot;, but</span>
<span class="sd">                `year=2010, year_op=&quot;&lt;&quot;` =&gt; &quot;... WHERE year&lt;2010&quot;</span>

<span class="sd">    Returns:</span>
<span class="sd">        (str) sql command</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(yaml|yml)$&#39;</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
            <span class="n">config</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">NAMED_QUERY_DIR</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s1">.yaml&#39;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">table</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">uppercase_table</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;defaults&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;init&#39;</span><span class="p">][</span><span class="s1">&#39;table&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">process_named_query_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">process_named_query_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">qc</span> <span class="o">=</span> <span class="n">QueryConstructor</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">select</span><span class="p">:</span>
        <span class="n">qc</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">select</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
        <span class="n">qc</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">**</span><span class="n">values</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
        <span class="n">qc</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qc</span><span class="o">.</span><span class="n">sql</span><span class="p">()</span></div>



<div class="viewcode-block" id="table_names">
<a class="viewcode-back" href="../../docs/spectral_trend_database.html#spectral_trend_database.query.table_names">[docs]</a>
<span class="k">def</span> <span class="nf">table_names</span><span class="p">(</span>
        <span class="n">project</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">GCP_PROJECT</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">DATASET_NAME</span><span class="p">,</span>
        <span class="n">select</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;table_name&#39;</span><span class="p">,</span>
        <span class="n">run_query</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">to_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">to_dataframe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">bq</span><span class="o">.</span><span class="n">QueryJob</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;select </span><span class="si">{</span><span class="n">select</span><span class="si">}</span><span class="s2"> from `</span><span class="si">{</span><span class="n">project</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">database</span><span class="si">}</span><span class="s2">.INFORMATION_SCHEMA.TABLES`&quot;</span>
    <span class="k">if</span> <span class="n">run_query</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span> <span class="n">to_dataframe</span><span class="o">=</span><span class="n">to_dataframe</span> <span class="ow">or</span> <span class="n">to_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">to_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">table_name</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sql</span></div>



<div class="viewcode-block" id="column_names">
<a class="viewcode-back" href="../../docs/spectral_trend_database.html#spectral_trend_database.query.column_names">[docs]</a>
<span class="k">def</span> <span class="nf">column_names</span><span class="p">(</span>
        <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">GCP_PROJECT</span><span class="p">,</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">DATASET_NAME</span><span class="p">,</span>
        <span class="n">select</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;column_name&#39;</span><span class="p">,</span>
        <span class="n">run_query</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">to_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">to_dataframe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">bq</span><span class="o">.</span><span class="n">QueryJob</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;select </span><span class="si">{</span><span class="n">select</span><span class="si">}</span><span class="s2"> from `</span><span class="si">{</span><span class="n">project</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">database</span><span class="si">}</span><span class="s2">.INFORMATION_SCHEMA.COLUMNS`&quot;</span>
    <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;ALL&#39;</span><span class="p">]:</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; WHERE table_name = &quot;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
    <span class="k">if</span> <span class="n">run_query</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span> <span class="n">to_dataframe</span><span class="o">=</span><span class="n">to_dataframe</span> <span class="ow">or</span> <span class="n">to_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">to_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">column_name</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sql</span></div>



<div class="viewcode-block" id="run">
<a class="viewcode-back" href="../../docs/spectral_trend_database.html#spectral_trend_database.query.run">[docs]</a>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">select</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">DEFAULT_QUERY_CONFIG</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sql</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">print_sql</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">project</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">bq</span><span class="o">.</span><span class="n">Client</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">to_dataframe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">values</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">bq</span><span class="o">.</span><span class="n">QueryJob</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; queries bigquery</span>

<span class="sd">    Executes a bigquery query either through an explicit sql string, using the</span>
<span class="sd">    `sql` arg, or by creating a sql-string using the `named_sql` method above.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (Optional[str]): name of preconfigured config file</span>
<span class="sd">        table (Optional[str]):</span>
<span class="sd">            (required if name is None) table-name: queries a</span>
<span class="sd">            single table with optional `WHERE` clause added through</span>
<span class="sd">            `values` kwargs.</span>
<span class="sd">        config (Union[str,dict]=c.DEFAULT_QUERY_CONFIG):</span>
<span class="sd">            configuration dictionary containg sql-config with key &lt;name&gt;</span>
<span class="sd">            if (str):</span>
<span class="sd">                if re.search(r&#39;(yaml|yml)$&#39;, &lt;config&gt;) loads yaml file with at &lt;path config&gt;</span>
<span class="sd">                else loads yaml at &#39;&lt;project-root&gt;/config/named_queries/&lt;config&gt;.yaml&#39;</span>
<span class="sd">        limit (int=None):</span>
<span class="sd">            if exits add &quot;LIMIT &lt;limit&gt;&quot; to end of SQL call</span>
<span class="sd">        sql (str=None): if &lt;name&gt; not provided, explicit sql command to use in query</span>
<span class="sd">        print_sql (bool = False): if true print sql-string before executing query</span>
<span class="sd">        project (str=None): gcp project name</span>
<span class="sd">        client (bq.Client=None):</span>
<span class="sd">            instance of bigquery client</span>
<span class="sd">            if None a new one will be instantiated</span>
<span class="sd">        **values:</span>
<span class="sd">            values for where clause (see usage above)</span>

<span class="sd">    Returns:</span>
<span class="sd">        (str) sql command</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">bq</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sql</span> <span class="ow">and</span> <span class="n">limit</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; LIMIT </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">elif</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">table</span><span class="p">:</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="n">named_sql</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
            <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
            <span class="o">**</span><span class="n">values</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">sql</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">print_sql</span><span class="p">:</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">to_dataframe</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">resp</span></div>



<span class="c1">#</span>
<span class="c1"># INTERNAL</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">_safe_prepend_keys</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">TABLE_KEYS</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v</span><span class="p">):</span>
                <span class="n">value</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">value</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Spectral Trend Database</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Brookie Guzder-Williams.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>